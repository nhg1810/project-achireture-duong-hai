{{!-- js for this page --}}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
{{!-- sweet alert --}}
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  $(document).ready(function () {
    //add new cate personal
    $(".btn-add-cate-role").click(function () {
      let nameRole = $(".name-role").val();
      let desRole = $(".descript-role").val();
      if (nameRole == "" || desRole == "") {
        Swal.fire({
          icon: 'error',
          title: 'Lỗi...',
          text: 'Chưa điền đủ thông tin trong form!',
        })
      } else {
        $(this).html('Đang tải...')
        $(this).addClass('btn-outline-secondary').removeClass('btn-add-cate-role').removeClass('btn-success');

        //fetch api post all cate role
        fetch("add-cate-personal", {
          method: "POST", // or 'PUT'
          headers: {
            Accept: 'application.json',
            'Content-Type': 'application/json'
          },
          //data;
          body: JSON.stringify({
            'nameRole': nameRole,
            'descriptionRole': desRole,
          })
        })
          .then((response) => response.json())

          .then((data) => {
            $(this).removeClass('btn-outline-secondary').addClass('btn-add-cate-role').addClass('btn-success');
            $(this).html('Đăng')
            Swal.fire({
              position: 'top-end',
              icon: 'Thành công',
              title: 'Thêm vị trí trong công ty thành công !',
              showConfirmButton: false,
              timer: 1500
            })
            showAllCateRole();
          })
          .catch((error) => {
            console.log("Error:", error);
          });
      }
    })
    showAllCateRole()
    function showAllCateRole() {
      $.ajax({
        url: 'get-all-role-personal',
        type: 'GET',
        dataType: "json",
        encode: true,
      }).done(function (data) {
        let html = ``;
        let option_html = ``;
        data.map((item) => {
          option_html += `<option value="` + item._id + `">` + item.nameRole + `</option>`;
          html += ` <tr>
                        <td>
                          `+ item.nameRole + `
                        </td>

                        <td>
                          `+ item.descriptionRole + `
                        </td>
                        <td>
                          <button type="button" data-id-role="`+ item._id + `" class="btn btn-danger btn-sm btn-icon-text btn-del-role"><i
                              class="mdi mdi-delete"></i></button>
                          <button type="button" class="btn btn-success btn-sm btn-icon-text"><i
                              class="mdi mdi-lead-pencil"></i></button>
                        </td>
                      </tr>`;
        })
        $(".cate-personal").html(option_html);
        $(".all-role-personal").html(html);
        //delete cate role
        $(".btn-del-role").click(function () {
          Swal.fire({
            title: 'Bạn có chắc muốn xoá loại nhân sự này?',
            text: "Có thể sẽ không xoá được nếu loại nhân sự này thuộc một người nào đó!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Chắc chẵn'
          }).then((result) => {
            if (result.isConfirmed) {
              let dataId = $(this).attr('data-id-role');
              //check coi cate này có tồn tại trong các nhân sự hiện tại không
              if (dataId) {
                fetch("delete-role-personal", {
                  method: "POST", // or 'PUT'
                  headers: {
                    Accept: 'application.json',
                    'Content-Type': 'application/json'
                  },
                  //data;
                  body: JSON.stringify({ '_id': dataId })
                })
                  .then((response) => response.json())

                  .then((data) => {
                    if (data == 'success') {
                      showAllCateRole()
                      showAllPersonalInf()
                      Swal.fire({
                        position: 'top-end',
                        icon: 'success',
                        title: 'Xoá thành công 1 dự án !',
                        showConfirmButton: false,
                        timer: 1500
                      })
                    }
                  })
                  .catch((error) => {
                    console.log("Error:", error);
                  });

              }

            }
          })

        }

        )
      })
    }

    //get all personnal inf
    showAllPersonalInf()
    function showAllPersonalInf() {
      $.ajax({
        url: 'get-all-personal',
        type: 'GET',
        dataType: "json",
        encode: true,
      }).done(function (data) {
        let html = '';
        data.map((item) => {
          html += `                      <tr>
                        <td class="py-1">
                          <img src="`+ item.imageAvata + `" alt="image" />
                        </td>
                        <td>
                          `+ item.name + `
                        </td>

                        <td>
                           `+ item.birth + `
                        </td>`;
          if (item.role) {
            html += ` <td>
                              `+ item.role.nameRole + `
                        </td>`
          } else {
            html += `<td>không thuộc vị trí nào</td>`
          }

          html += `<td>
                          `+ item.contact + `
                        </td>
                        <td>
                           `+ item.email + `
                        </td>
                        <td>
                          <button type="button" data-id-personal= "`+ item._id + `" class="btn btn-danger btn-del-personal btn-sm btn-icon-text"><i
                              class="mdi mdi-delete" ></i></button>
                          <button type="button" class="btn btn-success btn-sm btn-icon-text"><i
                              class="mdi mdi-lead-pencil"></i></button>
                        </td>
                      </tr>`
        })
        $(".tbl-all-personal-inf").html(html);
        $(".btn-del-personal").click(function () {
          Swal.fire({
            title: 'Bạn có chắc muốn xoá nhân sự này?',
            text: "Điều này sẽ mất thông tin của người này khi bạn xoá!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Chắc chắn!'
          }).then((result) => {
            if (result.isConfirmed) {
              let dataId = $(this).attr('data-id-personal');
              if (dataId) {
                fetch("delete-personal", {
                  method: "POST", // or 'PUT'
                  headers: {
                    Accept: 'application.json',
                    'Content-Type': 'application/json'
                  },
                  //data;
                  body: JSON.stringify({ '_id': dataId })
                })
                  .then((response) => response.json())

                  .then((data) => {
                    if (data == 'success') {
                      showAllCateRole()
                      Swal.fire(
                        'Xoá thành công!',
                        'Nhân sự này đã được xoá',
                        'success'
                      )
                      showAllPersonalInf()
                    }
                  })
                  .catch((error) => {
                    console.log("Error:", error);
                  });

              }

            }
          })

        })

      })
    }


    //add new personal
    $(".btn-add-personal").click(function () {
      let descript_personal = $(".descript-personal").val();
      let file_img_personal = $(".file-img-personal").val();
      let cate_personal = $(".cate-personal").val();
      let contact_personal = $(".contact-personal").val();
      let address_personal = $(".address-personal").val();
      let email_personal = $(".email-personal").val();
      let birth_personal = $(".birth-personal").val();
      let name_personal = $(".name-personal").val();
      if (descript_personal == "" || file_img_personal == "" || cate_personal == "" || contact_personal == "" || address_personal == "" ||
        email_personal == "" || birth_personal == "" || name_personal == "") {
        Swal.fire(
          'Đang điền thiếu thông tin',
          'Vui lòng kiếm tra lại',
          'question'
        )
      } else {
        $("#f-add-personal").submit();
      }
    })
  })

</script>
<div class="layout-edit"
  style="z-index: 11;position: absolute; width: 100%; height: 100%; position: fixed; 
  top: 0; left: 0; background-color: rgb(49 ,49, 49, 0.5); display: none;">

</div>
<div class="content-wrapper">
  <div class="row">
    <div class="col-md-8 grid-margin stretch-card">
      <div class="card">
        <div class="row">
          <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Nhân Sự</h4>
                <p class="card-description">
                  Đây là bảng:
                  <code>Quản lý thông tin nhân sự của công ty.</code>
                </p>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>

                        <th>
                          Ảnh đại diện
                        </th>
                        <th>
                          Họ và tên
                        </th>

                        <th>
                          Ngày sinh
                        </th>
                        <th>Vị trí</th>
                        <th>
                          Liên lạc
                        </th>
                        <th>
                          Email
                        </th>
                        <th>
                          Địa chỉ
                        </th>
                      </tr>
                    </thead>
                    <tbody class="tbl-all-personal-inf">

                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 grid-margin stretch-card">
      <div class="card">

        <form id="f-add-personal" action="add-personal-inf" enctype="multipart/form-data" method="post">
          <div class="card-body">
            <h4 class="card-title">Thêm Nhân Sự</h4>
            <div class="form-group">
              <label>Tên Nhân Sự</label>
              <input type="text" name="name_personal" class="form-control name-personal" placeholder="Tên nhân sự" />
            </div>
            <div class="form-group">
              <label>Ngày sinh</label>
              <input type="text" name="birth_personal" class="form-control birth-personal"
                placeholder="Nhập ngày sinh" />
            </div>
            <div class="form-group">
              <label>Ngày sinh</label>
              <input type="text" name="email_personal" class="form-control email-personal" placeholder="Nhập Email" />
            </div>
            <div class="form-group">
              <label>Địa chỉ</label>
              <input type="text" name="address_personal" class="form-control address-personal"
                placeholder="Nhập địa chỉ" />
            </div>
            <div class="form-group">
              <label>Liên lạc</label>
              <input type="text" name="contact_personal" class="form-control contact-personal"
                placeholder="Nhập phương thức liên lạc" />
            </div>
            <div class="form-group">
              <label>Chọn Loại Dự Án</label>
              <select class="js-example-basic-single w-100 cate-personal" name="cate_personal">

              </select>
            </div>
            <div class="form-group">
              <label>Thêm ảnh</label>

              <input type="file" name="files" class="file-img-personal">
            </div>
            <div class="form-group">
              <label for="exampleTextarea1">Mô Tả Nhân Sự</label>
              <textarea name="descript_personal" class="form-control descript-personal" id="exampleTextarea1" rows="44"
                style="height: 100px;"></textarea>
            </div>
            <button type="button" class="btn btn-success btn-icon-text btn-add-personal">
              <i class="ti-upload btn-icon-prepend"></i>
              Đăng
            </button>
          </div>
        </form>

      </div>
    </div>


  </div>
  <div class="row">
    <div class="col-md-8 grid-margin stretch-card">
      <div class="card">
        <div class="row">
          <div class="col-lg-12 grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Chức vụ Nhân Sự</h4>
                <p class="card-description">
                  Đây là bảng:
                  <code>Quản lý thông tin các vị trí chức vụ trong công ty.</code>
                </p>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>


                        <th>
                          Tên chức vụ
                        </th>

                        <th>
                          Mô tả chức vụ
                        </th>

                        <th>
                          Thao tác
                        </th>
                      </tr>
                    </thead>
                    <tbody class="all-role-personal">


                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 grid-margin stretch-card">
      <div class="card">
        <form action="">
          <div class="card-body">
            <h4 class="card-title">Thêm Chức Vụ Nhân Sự</h4>
            <div class="form-group">
              <label>Tên Chức Vụ</label>
              <input type="text" class="form-control name-role" placeholder="Tên chức vụ " />
            </div>
            <div class="form-group">
              <label for="exampleTextarea1">Mô Tả Vị trí</label>
              <textarea class="form-control descript-role" id="exampleTextarea1" rows="44"
                style="height: 100px;"></textarea>
            </div>
            <button type="button" class="btn  btn-icon-text btn-success btn-add-cate-role">
              <i class="ti-upload btn-icon-prepend"></i>
              Đăng
            </button>
          </div>
        </form>
      </div>
    </div>


  </div>
</div>